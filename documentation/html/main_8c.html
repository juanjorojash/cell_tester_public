<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Multichemistry cell charge and discharge system: main.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Multichemistry cell charge and discharge system
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">main.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Main source file. Includes the main loop and the interruption service routine.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="charger__discharger_8h_source.html">charger_discharger.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a6288eba0f8e8ad3ab1544ad731eb7667"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a6288eba0f8e8ad3ab1544ad731eb7667">main</a> (void)</td></tr>
<tr class="memdesc:a6288eba0f8e8ad3ab1544ad731eb7667"><td class="mdescLeft">&#160;</td><td class="mdescRight"><b> This is the main function of the program. It initializes the system in every reset and takes care of several tasks that are excecuted every second. </b>  <a href="#a6288eba0f8e8ad3ab1544ad731eb7667">More...</a><br /></td></tr>
<tr class="separator:a6288eba0f8e8ad3ab1544ad731eb7667"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae1d3159fc186c5f0bef6dd9a22c58859"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#ae1d3159fc186c5f0bef6dd9a22c58859">__interrupt</a> ()</td></tr>
<tr class="memdesc:ae1d3159fc186c5f0bef6dd9a22c58859"><td class="mdescLeft">&#160;</td><td class="mdescRight"><b> This is the interruption service function. It will interrupt the code whenever the Timer1 overflow (0.975625 milliseconds) or when any character is received from the serial terminal via UART. </b>  <a href="#ae1d3159fc186c5f0bef6dd9a22c58859">More...</a><br /></td></tr>
<tr class="separator:ae1d3159fc186c5f0bef6dd9a22c58859"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Main source file. Includes the main loop and the interruption service routine. </p>
<p><a class="el" href="main_8c.html" title="Main source file. Includes the main loop and the interruption service routine.">main.c</a> </p><dl class="section author"><dt>Author</dt><dd>Juan J. Rojas </dd></dl>
<dl class="section date"><dt>Date</dt><dd>7 Aug 2018 </dd></dl>
<dl class="section user"><dt>Institution:</dt><dd>LaSEINE / CeNT. Kyushu Institute of Technology. </dd></dl>
<dl class="section user"><dt>Mail:</dt><dd><a href="#" onclick="location.href='mai'+'lto:'+'jua'+'n.'+'roj'+'as'+'@te'+'c.'+'ac.'+'cr'; return false;">juan.<span style="display: none;">.nosp@m.</span>roja<span style="display: none;">.nosp@m.</span>s@tec<span style="display: none;">.nosp@m.</span>.ac.<span style="display: none;">.nosp@m.</span>cr</a> </dd></dl>
<dl class="section user"><dt>Git repository:</dt><dd><a href="https://bitbucket.org/juanjorojash/cell_charger_discharger">https://bitbucket.org/juanjorojash/cell_charger_discharger</a> </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="ae1d3159fc186c5f0bef6dd9a22c58859"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae1d3159fc186c5f0bef6dd9a22c58859">&#9670;&nbsp;</a></span>__interrupt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void __interrupt </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><b> This is the interruption service function. It will interrupt the code whenever the Timer1 overflow (0.975625 milliseconds) or when any character is received from the serial terminal via UART. </b> </p>
<p>This function performs the folowing tasks: </p>
<p>Check the <b>Timer1</b> interrupt flag, if it is set, the folowing task are executed:</p>
<ol>
<li>
<p class="startli">Load the <b>Timer1</b> 16-bit register so it overflow every 0.975625 ms</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Clear the <b>Timer1</b> interrupt flag</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Read the ADC channel <a class="el" href="charger__discharger_8h.html#a420d619b855e71d5e8d4c26e2d0a0461" title="Definition of ADC channel for voltage measurements. AN10(RB1)">V_CHAN</a> and store the value in <a class="el" href="charger__discharger_8h.html#ac5f38113a34f9eab3e7782eade81d266" title="Last voltage ADC measurement.">v</a>. Using the <a class="el" href="charger__discharger_8c.html#abf70b9e763a525b6113c0349583e7ac0" title="This function read the ADC and store the data in the coresponding variable.">read_ADC()</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Read the ADC channel <a class="el" href="charger__discharger_8h.html#a72da0b033e023b574cca6ab663e25fca" title="Definition of ADC channel for current measurements. AN12(RB0)">I_CHAN</a> and store the value in <a class="el" href="charger__discharger_8h.html#a78f7a37dba921e0b0347b960fb40bc51" title="Last current ADC measurement.">i</a>. Using the <a class="el" href="charger__discharger_8c.html#abf70b9e763a525b6113c0349583e7ac0" title="This function read the ADC and store the data in the coresponding variable.">read_ADC()</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Substract the 2.5V bias from <a class="el" href="charger__discharger_8h.html#a78f7a37dba921e0b0347b960fb40bc51" title="Last current ADC measurement.">i</a>, store the absolute value in <a class="el" href="charger__discharger_8h.html#a78f7a37dba921e0b0347b960fb40bc51" title="Last current ADC measurement.">i</a></p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Read the ADC channel <a class="el" href="charger__discharger_8h.html#a10ddb4ca8b21ecdf02ab19d67cb9142c" title="Definition of ADC channel for temperature measurements. AN4(RA5)">T_CHAN</a> and store the value in <a class="el" href="charger__discharger_8h.html#a3636f663c6b00463f1bad29dd9617997" title="Last temperature ADC measurement.">t</a>. Using the <a class="el" href="charger__discharger_8c.html#abf70b9e763a525b6113c0349583e7ac0" title="This function read the ADC and store the data in the coresponding variable.">read_ADC()</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Call the <a class="el" href="charger__discharger_8c.html#a0c80a804f63cdf1b40bca055d0b2d77d" title="This function calls the PI control loop for current or voltage depending on the value of the cmode va...">control_loop()</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Call the <a class="el" href="charger__discharger_8c.html#a6f1efdf53830030b8d4b67843aad1870" title="This function calculate the averages.">calculate_avg()</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Call the <a class="el" href="charger__discharger_8c.html#a4774aa6e41b08b4ff32010c008fa3a99" title="This function control the timing.">timing()</a> function</p>
<p class="endli"></p>
</li>
<li>
If the <b>Timer1</b> interrupt flag is set, there is a timing error, print "TIMING_ERROR" into the terminal. </li>
</ol>
<p>Check the <b>UART</b> reception interrupt flag, if it is set, the folowing task are executed:</p>
<ol>
<li>
<p class="startli">Check for any errors and clear them</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Store the received character</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">If a <b>"c"</b> was received, the process shall stop, then:</p>
<ul>
<li>Stop the converter by calling the <a class="el" href="charger__discharger_8h.html#ae1cb4a0872e924cf862a97b33dd2edf0" title="Stop the converter.">STOP_CONVERTER()</a> macro</li>
<li>Go to <a class="el" href="charger__discharger_8h.html#aa19be6305a5a4485e1e70de70ed7d677ae4634ae4352b512b38c5da9dc1610ca6" title="&quot;Stand by&quot; state, defined by function fSTANDBY()">STANDBY</a> state</li>
</ul>
<p class="endli"></p>
</li>
<li>
<p class="startli">If <code>an</code> <b>"n"</b> was received, the system shall jump to the next cell, then:</p>
<ul>
<li>Stop the converter by calling the <a class="el" href="charger__discharger_8h.html#ae1cb4a0872e924cf862a97b33dd2edf0" title="Stop the converter.">STOP_CONVERTER()</a> macro</li>
<li>Go to <a class="el" href="charger__discharger_8h.html#aa19be6305a5a4485e1e70de70ed7d677a2df4f4d04ec310a30dd8eaac64f883a2" title="&quot;Is done&quot; state, defined by function fISDONE()">ISDONE</a> state</li>
</ul>
<p class="endli"></p>
</li>
<li>
<p class="startli">In any other case, do nothing</p>
<p class="endli"></p>
</li>
</ol>

</div>
</div>
<a id="a6288eba0f8e8ad3ab1544ad731eb7667"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6288eba0f8e8ad3ab1544ad731eb7667">&#9670;&nbsp;</a></span>main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void main </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><b> This is the main function of the program. It initializes the system in every reset and takes care of several tasks that are excecuted every second. </b> </p>
<p>This function performs the folowing tasks: </p>
<ul>
<li>
<p class="startli">Call the <a class="el" href="charger__discharger_8h.html#a9efe22aaead3a5e936b5df459de02eba" title="Function to initialize all the PIC16F1787 registers.">initialize</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b> The main loop repeats the following forever: </b></p>
<ul>
<li>
<p class="startli">Check the <a class="el" href="charger__discharger_8h.html#a29f21565ea58c567076a7677b0cec206" title="1 second flag">SECF</a> flag, if it is set, 1 second has passed since last execution, so the folowing task are executed:</p>
<ol>
<li>
<p class="startli">Clear the <a class="el" href="charger__discharger_8h.html#a29f21565ea58c567076a7677b0cec206" title="1 second flag">SECF</a> flag to restart the 1 second timer</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Scale the average measured values by calling the <a class="el" href="charger__discharger_8h.html#a8eda4a7f25b80578a7cee00f6c9b6e4a" title="This function takes care of scaling the average values to correspond with their real values.">scaling</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Print the log in the serial terminal by calling the <a class="el" href="charger__discharger_8h.html#a0b8b498532d1d667c624601a3cf715bc" title="This function takes care of calculating the average values printing the log data using the UART.">log_control</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Check if the system shall change to CV mode by calling the <a class="el" href="charger__discharger_8h.html#a1db67160f1d6e9368e8c07df1c904eb4" title="This function switches between CC and CV mode.">cc_cv_mode</a> function</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Call the <a class="el" href="state__machine_8c.html#a39943273f62c5b66673647a0a6cdb457" title="This function contain the transition definition for the states of the machine.">state_machine</a> function</p>
<p class="endli"></p>
</li>
<li>
Call the <a class="el" href="charger__discharger_8h.html#a4126a9c7eed2c3658428ce1613f62848">temp_protection</a> function </li>
</ol>
</li>
</ul>
</li>
</ul>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
